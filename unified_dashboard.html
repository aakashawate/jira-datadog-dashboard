<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        /* Header */
        .header {
            background: #4a5568;
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
        }

        .header-nav {
            display: flex;
            gap: 15px;
        }

        .header-nav span {
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .header-nav span:hover {
            background: rgba(255,255,255,0.1);
        }

        .header-nav span.active {
            background: #3182ce;
        }

        .search-container {
            display: flex;
            gap: 10px;
        }

        .search-box {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            width: 250px;
        }

        .search-btn {
            background: #3182ce;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Main Content */
        .container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Section Headers */
        .section-header {
            background: #3182ce;
            color: white;
            padding: 12px 20px;
            margin: 20px 0 0 0;
            border-radius: 6px 6px 0 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-content {
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 6px 6px;
            padding: 20px;
        }

        /* Jira Issues Table */
        .issues-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .issues-table th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
            font-weight: 600;
            color: #4a5568;
        }

        .issues-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
            font-size: 14px;
        }

        .issue-summary {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .issues-table th:nth-child(1) { width: 80px; }   /* Issue ID */
        .issues-table th:nth-child(2) { width: 35%; }    /* Summary */
        .issues-table th:nth-child(3) { width: 12%; }    /* Created Date */
        .issues-table th:nth-child(4) { width: 12%; }    /* Created By */
        .issues-table th:nth-child(5) { width: 12%; }    /* Assigned To */
        .issues-table th:nth-child(6) { width: 10%; }    /* Status */
        .issues-table th:nth-child(7) { width: 12%; }    /* Closed Date */

        .issue-key {
            background: #3182ce;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }

        .status-open { background: #fed7d7; color: #c53030; }
        .status-progress { background: #fbd38d; color: #dd6b20; }
        .status-resolved { background: #c6f6d5; color: #38a169; }
        .status-todo { background: #bee3f8; color: #3182ce; }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .metric-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 20px;
        }

        .metric-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4a5568;
        }

        .metric-chart {
            height: 200px;
            background: #f7fafc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #718096;
            position: relative;
            overflow: hidden;
        }

        /* Chart styles */
        .chart-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .chart-line {
            position: absolute;
            bottom: 0;
            background: linear-gradient(to top, rgba(49, 130, 206, 0.3), rgba(49, 130, 206, 0.1));
            border-top: 2px solid #3182ce;
        }

        .chart-line.cpu { background: linear-gradient(to top, rgba(49, 130, 206, 0.3), rgba(49, 130, 206, 0.1)); border-color: #3182ce; }
        .chart-line.memory { background: linear-gradient(to top, rgba(56, 161, 105, 0.3), rgba(56, 161, 105, 0.1)); border-color: #38a169; }
        .chart-line.disk { background: linear-gradient(to top, rgba(237, 137, 54, 0.3), rgba(237, 137, 54, 0.1)); border-color: #ed8936; }
        .chart-line.network { background: linear-gradient(to top, rgba(128, 90, 213, 0.3), rgba(128, 90, 213, 0.1)); border-color: #805ad5; }

        /* Status Summary */
        .status-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .status-count {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .status-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Refresh Info */
        .refresh-info {
            text-align: right;
            color: #718096;
            font-size: 12px;
            margin-bottom: 10px;
        }

        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #718096;
        }

        /* Time selector */
        .time-selector {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-dropdown {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 12px;
        }

        /* Section Visibility */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Tab styling */
        .header-nav span {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
            font-weight: 500;
            border: 2px solid transparent;
        }

        .header-nav span:hover {
            background: rgba(255,255,255,0.1);
            opacity: 0.9;
        }

        .header-nav span.active {
            background: #3182ce;
            opacity: 1;
            border: 2px solid #2c5aa0;
            font-weight: 600;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Section transitions */
        .section {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .section.active {
            display: block;
            opacity: 1;
        }

        /* DataDog section specific styling */
        #datadogSection .section-header {
            background: #632ca6;
        }

        #datadogSection .section-content {
            padding: 0;
            border: none;
        }

        /* DataDog iframe styling */
        #datadogSection iframe {
            width: 100%;
            height: 800px;
            border: none;
            border-radius: 6px;
            background: #f8f9fa;
        }

        /* Responsive iframe */
        @media (max-width: 768px) {
            #datadogSection iframe {
                height: 600px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="header-title">üìä Unified Monitoring Dashboard</div>
            <div class="header-nav">
                <span id="jiraTab" class="active" data-section="jira">üìã Jira</span>
                <span id="datadogTab" data-section="datadog">üìà DataDog</span>
            </div>
        </div>
    <button class="logout-btn" style="background: #e53e3e; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">Logout</button>
    </div>

    <div class="container">
        <!-- Jira Issues Section -->
        <div id="jiraSection" class="section active">
            <div class="section-header">
                üìã Jira Issues Overview
            </div>
            <div class="section-content">
                <div class="refresh-info">
                    Last updated: <span id="lastUpdated">Loading...</span>
                </div>
                
                <div class="status-summary">
                    <div class="status-card">
                        <div class="status-count" id="totalIssues">-</div>
                        <div class="status-label">Total Issues</div>
                    </div>
                    <div class="status-card">
                        <div class="status-count" id="openIssues" style="color: #c53030;">-</div>
                        <div class="status-label">Open</div>
                    </div>
                    <div class="status-card">
                        <div class="status-count" id="progressIssues" style="color: #dd6b20;">-</div>
                        <div class="status-label">In Progress</div>
                    </div>
                    <div class="status-card">
                        <div class="status-count" id="resolvedIssues" style="color: #38a169;">-</div>
                        <div class="status-label">Resolved</div>
                    </div>
                    <div class="status-card">
                        <div class="status-count" id="todoIssues" style="color: #3182ce;">-</div>
                        <div class="status-label">To Do</div>
                    </div>
                </div>

                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>üé´ Issue ID</th>
                            <th>üìù Summary</th>
                            <th>ÔøΩ Created Date</th>
                            <th>üë§ Created By</th>
                            <th>üë• Assigned To</th>
                            <th>ÔøΩ Status</th>
                            <th>‚úÖ Closed Date</th>
                        </tr>
                    </thead>
                    <tbody id="issuesTableBody">
                        <tr>
                            <td colspan="7" class="loading">Loading Jira issues...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- DataDog Metrics Section -->
        <div id="datadogSection" class="section">
            <div class="section-header">
                üìà Live DataDog Dashboard
            </div>
            <div class="section-content" style="padding: 0; border: none;">
                <!-- Embedded DataDog Dashboard -->
                <iframe 
                    src="https://p.ap1.datadoghq.com/sb/78af43bd-7452-11f0-927b-caaf99af3ba2-f48f84656f3ab88ec257f2369bddd9c5"
                    width="100%" 
                    height="800px" 
                    frameborder="0"
                    style="border: none; border-radius: 6px;"
                    title="DataDog Monitoring Dashboard">
                </iframe>
                
                <!-- Fallback content if iframe doesn't load -->
                <div id="datadogFallback" style="display: none; padding: 40px; text-align: center; background: #f8f9fa; border-radius: 6px;">
                    <h3 style="color: #4a5568; margin-bottom: 20px;">üìà DataDog Dashboard</h3>
                    <p style="color: #718096; margin-bottom: 20px;">
                        The embedded dashboard couldn't be loaded. This might be due to browser security settings or authentication requirements.
                    </p>
                    <a href="https://p.ap1.datadoghq.com/sb/78af43bd-7452-11f0-927b-caaf99af3ba2-f48f84656f3ab88ec257f2369bddd9c5" 
                       target="_blank" 
                       style="background: #632ca6; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600;">
                       üîó Open DataDog Dashboard in New Tab
                    </a>
                    <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 6px; text-align: left;">
                        <h4 style="color: #4a5568; margin-bottom: 15px;">Dashboard Details:</h4>
                        <ul style="color: #718096; line-height: 1.6;">
                            <li><strong>URL:</strong> https://p.ap1.datadoghq.com/sb/...</li>
                            <li><strong>API Key:</strong> fc50b4d7ebb710a4f1eff7a3a42330df</li>
                            <li><strong>Status:</strong> Ready for integration</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let jiraData = null;
        const DATADOG_API_KEY = 'fc50b4d7ebb710a4f1eff7a3a42330df';  // For reference only
        
        // Load Jira data
        async function loadJiraData() {
            try {
                // Add cache-busting timestamp to ensure fresh data
                const timestamp = new Date().getTime();
                const response = await fetch(`donation_platform_data/donation_issues.json?t=${timestamp}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                jiraData = await response.json();
                console.log('Jira data loaded successfully:', jiraData.total_issues, 'issues');
                renderJiraData();
            } catch (error) {
                console.error('Error loading Jira data:', error);
                document.getElementById('issuesTableBody').innerHTML = 
                    '<tr><td colspan="7" style="color: #e53e3e; text-align: center;">Failed to load Jira data: ' + error.message + '</td></tr>';
            }
        }

        // Render Jira data
        function renderJiraData() {
            console.log('renderJiraData called, jiraData:', jiraData);
            
            if (!jiraData || !jiraData.issues) {
                console.error('No Jira data or issues array found');
                return;
            }

            console.log('Rendering', jiraData.issues.length, 'issues');

            // Update summary counts
            const statusCounts = {
                total: jiraData.total_issues || 0,
                open: 0,
                progress: 0,
                resolved: 0,
                todo: 0
            };

            jiraData.issues.forEach(issue => {
                const status = issue.status.toLowerCase();
                if (status.includes('to do')) statusCounts.todo++;
                else if (status.includes('progress')) statusCounts.progress++;
                else if (status.includes('review')) statusCounts.open++;  // In Review counts as "open"
                else if (status.includes('done') || status.includes('closed') || status.includes('resolved')) statusCounts.resolved++;
            });

            console.log('Status counts:', statusCounts);

            document.getElementById('totalIssues').textContent = statusCounts.total;
            document.getElementById('openIssues').textContent = statusCounts.open;
            document.getElementById('progressIssues').textContent = statusCounts.progress;
            document.getElementById('resolvedIssues').textContent = statusCounts.resolved;
            document.getElementById('todoIssues').textContent = statusCounts.todo;
            document.getElementById('lastUpdated').textContent = new Date(jiraData.last_updated).toLocaleString();

            // Render issues table
            const tbody = document.getElementById('issuesTableBody');
            tbody.innerHTML = jiraData.issues.map(issue => {
                const statusClass = getStatusClass(issue.status);
                const createdDate = formatDate(issue.created);
                const closedDate = issue.closed_date ? formatDate(issue.closed_date) : '-';
                const createdBy = issue.created_by || issue.reporter || '-';
                const assignedTo = issue.assigned_to || issue.assignee || 'Unassigned';
                
                return `
                    <tr>
                        <td><a href="#" class="issue-key">${issue.key}</a></td>
                        <td class="issue-summary" title="${issue.summary || 'No summary'}">${truncateText(issue.summary || 'No summary', 50)}</td>
                        <td>${createdDate}</td>
                        <td>${createdBy}</td>
                        <td>${assignedTo}</td>
                        <td><span class="status-badge ${statusClass}">${issue.status}</span></td>
                        <td>${closedDate}</td>
                    </tr>
                `;
            }).join('');
        }

        // Get status CSS class
        function getStatusClass(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('open')) return 'status-open';
            if (statusLower.includes('progress')) return 'status-progress';
            if (statusLower.includes('resolved') || statusLower.includes('done') || statusLower.includes('closed')) return 'status-resolved';
            if (statusLower.includes('to do')) return 'status-todo';
            return 'status-todo';
        }

        // Format date helper function
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (error) {
                return dateString;
            }
        }

        // Truncate text helper function
        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // DataDog iframe is now embedded directly, no custom charts needed
        // Keeping these functions for potential future use with API data
        
        // Create animated chart (fallback function)
        function createAnimatedChart(containerId, type, color) {
            // This function is no longer used since we embed the real DataDog dashboard
            console.log('Custom charts not needed - using embedded DataDog dashboard');
        }

        // Navigation functionality
        function switchTab(targetSection) {
            console.log('Switching to section:', targetSection);
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                console.log('Hiding section:', section.id);
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.header-nav span').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show target section
            const section = document.getElementById(targetSection + 'Section');
            if (section) {
                section.classList.add('active');
                console.log('Showing section:', section.id);
            } else {
                console.error('Section not found:', targetSection + 'Section');
            }
            
            // Activate clicked tab
            const tab = document.querySelector(`[data-section="${targetSection}"]`);
            if (tab) {
                tab.classList.add('active');
                console.log('Activated tab:', targetSection);
            } else {
                console.error('Tab not found:', targetSection);
            }
            
            // Initialize charts if switching to DataDog
            if (targetSection === 'datadog') {
                console.log('Loading DataDog dashboard iframe...');
                checkDataDogIframe();
            }
        }

        // Check if DataDog iframe loads properly
        function checkDataDogIframe() {
            const iframe = document.querySelector('#datadogSection iframe');
            const fallback = document.getElementById('datadogFallback');
            
            if (iframe) {
                // Show fallback after 10 seconds if iframe doesn't load
                setTimeout(() => {
                    try {
                        // Try to access iframe content to see if it loaded
                        // If this throws an error, the iframe likely didn't load properly
                        iframe.contentDocument;
                    } catch (e) {
                        console.log('DataDog iframe may be blocked, showing fallback');
                        iframe.style.display = 'none';
                        if (fallback) fallback.style.display = 'block';
                    }
                }, 10000);
                
                // Handle iframe load events
                iframe.onload = function() {
                    console.log('DataDog iframe loaded successfully');
                };
                
                iframe.onerror = function() {
                    console.log('DataDog iframe failed to load, showing fallback');
                    iframe.style.display = 'none';
                    if (fallback) fallback.style.display = 'block';
                };
            }
        }

        // Initialize navigation
        function initializeNavigation() {
            console.log('Initializing navigation...');
            document.querySelectorAll('.header-nav span').forEach(tab => {
                console.log('Setting up tab:', tab.textContent, 'with data-section:', tab.getAttribute('data-section'));
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = e.target.getAttribute('data-section');
                    console.log('Tab clicked:', section);
                    if (section) {
                        switchTab(section);
                    }
                });
            });
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize navigation
            initializeNavigation();
            
            // Load data
            loadJiraData();
            
            // Refresh data every 5 minutes (Jira only - DataDog shows live via iframe)
            setInterval(() => {
                loadJiraData();
            }, 5 * 60 * 1000);
        });
    </script>
</body>
</html>
